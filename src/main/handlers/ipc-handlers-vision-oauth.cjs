/**
 * IPC Handlers for Google Vision OAuth
 * Handles OAuth flow for Google Cloud Vision API
 */

const { ipcMain } = require('electron');

/**
 * Setup Google Vision OAuth IPC handlers
 * @param {Object} db - DuckDB connection for storing OAuth data
 */
function setupVisionOAuthHandlers(db) {
  console.log('üîß Setting up Vision OAuth handlers...');

  /**
   * Start Google Vision OAuth flow
   * Uses the same OAuth client as Gemini since both are Google APIs
   */
  ipcMain.handle('vision:oauth:start', async () => {
    console.log('üîê Starting Google Vision OAuth flow...');
    
    try {
      // Call the command service OAuth endpoint (reuses Gemini OAuth)
      // Google OAuth provides access to multiple APIs with the same token
      const response = await fetch('http://localhost:3007/gemini.oauth.start', {
        method: 'POST',
        headers: {
          'Authorization': 'q6E53kWzIGoxkohxuih3A4xVS06PZn1I',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          action: 'gemini.oauth.start',
          payload: {
            // Request additional scopes for Cloud Vision API
            additionalScopes: ['https://www.googleapis.com/auth/cloud-vision']
          }
        })
      });

      const data = await response.json();
      
      if (data.success) {
        console.log('‚úÖ Google Vision OAuth completed successfully');
        
        // Store API key and OAuth tokens in DuckDB for vision service
        if (data.apiKey && data.tokens && db) {
          try {
            await db.run(`
              UPDATE mcp_services 
              SET api_key = ?,
                  oauth_access_token = ?,
                  oauth_refresh_token = ?,
                  oauth_token_expiry = ?,
                  oauth_scope = ?,
                  gemini_configured = true,
                  api_key_auto_generated = true,
                  api_key_service = 'vision.googleapis.com',
                  updated_at = CURRENT_TIMESTAMP
              WHERE name = 'vision'
            `, [
              data.apiKey,
              data.tokens.access_token,
              data.tokens.refresh_token,
              data.tokens.expiry_date ? new Date(data.tokens.expiry_date).toISOString() : null,
              data.tokens.scope
            ]);
            console.log('‚úÖ Google Vision API key and OAuth tokens stored in DuckDB');
          } catch (dbError) {
            console.error('‚ùå Failed to store Vision OAuth data in DuckDB:', dbError);
          }
        }
        
        return {
          success: true,
          message: 'Google Vision API connected successfully',
          status: data.status
        };
      } else {
        console.error('‚ùå Google Vision OAuth failed:', data.error);
        return {
          success: false,
          error: data.error
        };
      }
    } catch (error) {
      console.error('‚ùå Google Vision OAuth error:', error);
      return {
        success: false,
        error: error.message
      };
    }
  });

  /**
   * Get Google Vision status
   */
  ipcMain.handle('vision:status', async () => {
    try {
      // Check if vision service has OAuth configured
      if (db) {
        const result = await db.query(`
          SELECT 
            api_key,
            oauth_access_token,
            oauth_token_expiry,
            gemini_configured,
            api_key_auto_generated,
            api_key_service
          FROM mcp_services 
          WHERE name = 'vision'
        `);
        
        if (result.length > 0) {
          const service = result[0];
          const hasApiKey = !!service.api_key;
          const hasOAuth = !!service.oauth_access_token;
          const isExpired = service.oauth_token_expiry 
            ? new Date(service.oauth_token_expiry) < new Date()
            : false;
          
          return {
            success: true,
            configured: hasApiKey && hasOAuth && !isExpired,
            hasApiKey,
            hasOAuth,
            isExpired,
            apiKeyService: service.api_key_service,
            autoGenerated: service.api_key_auto_generated
          };
        }
      }
      
      return {
        success: true,
        configured: false,
        hasApiKey: false,
        hasOAuth: false
      };
    } catch (error) {
      console.error('‚ùå Failed to get Vision status:', error);
      return {
        success: false,
        error: error.message
      };
    }
  });

  /**
   * Revoke Google Vision OAuth
   */
  ipcMain.handle('vision:oauth:revoke', async () => {
    try {
      // Clear OAuth data from DuckDB
      if (db) {
        await db.run(`
          UPDATE mcp_services 
          SET api_key = NULL,
              oauth_access_token = NULL,
              oauth_refresh_token = NULL,
              oauth_token_expiry = NULL,
              oauth_scope = NULL,
              gemini_configured = false,
              api_key_auto_generated = false,
              api_key_service = NULL,
              updated_at = CURRENT_TIMESTAMP
          WHERE name = 'vision'
        `);
        console.log('‚úÖ Google Vision OAuth revoked and cleared from DuckDB');
      }
      
      return {
        success: true,
        message: 'Google Vision OAuth revoked successfully'
      };
    } catch (error) {
      console.error('‚ùå Failed to revoke Vision OAuth:', error);
      return {
        success: false,
        error: error.message
      };
    }
  });

  console.log('‚úÖ Vision OAuth handlers setup complete');
}

module.exports = { setupVisionOAuthHandlers };
